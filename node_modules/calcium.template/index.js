var razor = require('razorjs');

var calcium;
(function (calcium) {
    calcium.storage = require('calcium.storage');
})(calcium || (calcium = {}));
var calcium;
(function (calcium) {
    (function (template) {
        var overrides = razor;

        overrides.findView = function (viewName, cb) {
            template.storage.readstream(viewName, function (readstream) {
                unpack(readstream, function (content) {
                    cb(content);
                });
            });
        };

        overrides.getViewEtag = function (viewName) {
            return viewName;
        };

        function unpack(readstream, callback) {
            var buffer = [];

            readstream.setEncoding('utf8');

            readstream.on("data", function (chunk) {
                buffer.push(chunk);
            });

            readstream.on("end", function () {
                callback(buffer.join(''));
            });
        }

        template.storage = new calcium.storage.mount.Device();

        function render(path, model, callback) {
            template.storage.readstream(path, function (readstream) {
                if (!readstream) {
                    callback('cannot locate template: ' + path);

                    return;
                }

                unpack(readstream, function (content) {
                    try  {
                        var template = razor.compile(content, null);

                        template(model, null, function (content) {
                            callback(content);
                        });
                    } catch (e) {
                        callback('error: ' + e.toString());

                        return;
                    }
                });
            });
        }
        template.render = render;
    })(calcium.template || (calcium.template = {}));
    var template = calcium.template;
})(calcium || (calcium = {}));

exports = calcium.template;
module.exports = exports;