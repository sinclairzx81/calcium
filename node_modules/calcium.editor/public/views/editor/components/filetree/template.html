<style type="text/css">
        
    .icon-space {
            
        display        : inline-block;
            
        width          : 14px;
            
        height         : 14px;
            
        line-height    : 14px;

        vertical-align : text-top;
            
        margin-top     : 1px;
    }

</style>

<script type="text/javascript">

//----------------------------------------------------------------
// Dependancies
//----------------------------------------------------------------
//
// /calcium.api.js
// ../linq/linq.js
//

//----------------------------------------------------------------
// Storage Model
//----------------------------------------------------------------
var StorageModel = function(name, path) 
{    
    this.type     = ko.observable('storage');

    this.name     = ko.observable(name);

    this.path     = ko.observable(path);

    this.expanded = ko.observable(false);

    this.loading  = ko.observable(false);

    this.loaded   = ko.observable(false);

    this.contents = ko.observableArray([]);         
    
    this.toggle   = function()
    {
        this.expanded( !this.expanded() )

        if (this.expanded()) 
        {
            this.load();
        }
    }

    this.load = function()
    {   
        var that = this;
        
        if(!that.loaded())
        {
            that.loading(true);

            calcium.api.get("/storage" + this.path(), function(contents) {
            
                that.loading(false);

                that.loaded(true);

                contents = Enumerable.From              (contents)
                                     .OrderByDescending (function (n) { return n.type })
                                     .ThenBy            (function (n) { return n.name })
                                     .ToArray           ();
            
                that.contents([]);

                for(var n in contents) 
                {
                    switch( contents[n].type )
                    {
                        case "storage":

                            var model = new StorageModel( contents[n].name, contents[n].fullpath);

                            model.on("data", function(content) {  that.dispatch("data", content); });
                        
                            that.contents.push( model );

                            break;

                        case "folder":
                         
                            var model = new FolderModel( contents[n].name, contents[n].fullpath);

                            model.on("data", function(content) {  that.dispatch("data", content); });
                        
                            that.contents.push( model );

                            break;

                        case "file":
                        
                            var model = new FileModel( contents[n].name, contents[n].fullpath, contents[n].mime);

                            model.on("data", function(content) {  that.dispatch("data", content); });

                            that.contents.push( model );

                            break;
                    }
                }
            });
        }
    }

    // events

    this.events   = [];

    this.on       = function (eventname, callback) {

        this.events.push({eventname:eventname, callback:callback});

    }

    this.dispatch = function (eventname, data) {

        for(var n in this.events) {

            if (this.events[n].eventname == eventname) {

                this.events[n].callback(data);
            }
        }
    }
}

//----------------------------------------------------------------
// Folder Model
//----------------------------------------------------------------
var FolderModel = function(name, path) 
{    
    this.type     = ko.observable('folder');

    this.name     = ko.observable(name);

    this.path     = ko.observable(path);

    this.expanded = ko.observable(false);

    this.loading  = ko.observable(false);

    this.loaded   = ko.observable(false);

    this.contents = ko.observableArray([]);            
    
    this.toggle   = function()
    {
        this.expanded( !this.expanded() )

        if (this.expanded()) 
        {
            this.load();
        }
    }

    this.load     = function()
    {   
        var that = this;
        
        if(!that.loaded())
        {
            that.loading(true);

            calcium.api.get("/storage" + this.path(), function(contents) {
                
                that.loading(false);

                that.loaded(true);

                contents = Enumerable.From              (contents)
                                     .OrderByDescending (function (n) { return n.type })
                                     .ThenBy            (function (n) { return n.name })
                                     .ToArray           ();
            
                that.contents([]);

                for(var n in contents) 
                {
                    switch( contents[n].type )
                    {
                        case "storage":

                            var model = new StorageModel( contents[n].name, contents[n].fullpath);

                            model.on("data", function(content) {  that.dispatch("data", content); });
                        
                            that.contents.push( model );

                            break;

                        case "folder":
                         
                            var model = new FolderModel( contents[n].name, contents[n].fullpath);

                            model.on("data", function(content) {  that.dispatch("data", content); });
                        
                            that.contents.push( model );

                            break;

                        case "file":
                        
                            var model = new FileModel( contents[n].name, contents[n].fullpath, contents[n].mime);

                            model.on("data", function(content) {  that.dispatch("data", content); });

                            that.contents.push( model );

                            break;
                    }
                }
            });
        }
    }

    // events

    this.events   = [];

    this.on       = function (eventname, callback) {

        this.events.push({eventname:eventname, callback:callback});
    }

    this.dispatch = function (eventname, data) {

        for(var n in this.events) {

            if (this.events[n].eventname == eventname) {

                this.events[n].callback(data);
            }
        }
    }
}
//----------------------------------------------------------------
// File Model
//----------------------------------------------------------------
var FileModel = function(name, path, mime) 
{    
    this.type     = ko.observable('file');

    this.name     = ko.observable(name);

    this.path     = ko.observable(path);

    this.mime     = ko.observable(mime);

    this.loading  = ko.observable(false);

    this.loaded   = ko.observable(false);

    this.load     = function()
    {
        var that = this;

        that.loading(true);

        calcium.api.load("/storage" + this.path(), function(content) {

            that.loading(false);

            that.dispatch("data", {
                path    : that.path(),
                content : content
            });
        });
    }

    // events

    this.events = [];

    this.on = function (eventname, callback) {

        this.events.push({eventname:eventname, callback:callback});

    }

    this.dispatch = function (eventname, data) {

        for(var n in this.events) {

            if (this.events[n].eventname == eventname) {

                this.events[n].callback(data);
            }
        }
    }
}



</script>

<!-- StorageModel Template -->

<script type="text/html" id="template.storage">
        
    <div data-bind="if: loading">

        <!-- ko if: expanded() -->

        <a href="#" data-bind="click: toggle"><img class='icon-space' src="/public/views/editor/components/filetree/assets/preloader.gif" /><i class="icon-hdd"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

        <!-- ko ifnot: expanded() -->

        <a href="#" data-bind="click: toggle"><img class='icon-space' src="/public/views/editor/components/filetree/assets/preloader.gif" /><i class="icon-hdd"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

    </div>

    <div data-bind="ifnot: loading">
            
        <!-- ko if: expanded() -->

        <a href="#" data-bind="click: toggle"><i class="icon-chevron-down"></i><i class="icon-hdd"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

        <!-- ko ifnot: expanded() -->

        <a href="#" data-bind="click: toggle"><i class="icon-chevron-right"></i><i class="icon-hdd"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

    </div>   
               
    <div data-bind="if: expanded">

        <ul class="nav nav-list" data-bind="foreach: contents">
                
            <!-- ko if: type() == 'folder' -->

                <li data-bind="template:{name:'template.folder', data:$data}" />
                
            <!-- /ko -->
                        
            <!-- ko if: type() == 'file' -->

                <li data-bind="template:{name:'template.file', data:$data}" />

            <!-- /ko -->
            
        </ul>

    </div>

</script>
   
<!-- FolderModel Template -->

<script type="text/html" id="template.folder">

    <div data-bind="if: loading">

        <!-- ko if: expanded() -->

        <a href="#" data-bind="click: toggle"><img class='icon-space' src="/public/views/editor/components/filetree/assets/preloader.gif" /><i class="icon-folder-open"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

        <!-- ko ifnot: expanded() -->

        <a href="#" data-bind="click: toggle"><img class='icon-space' src="/public/views/editor/components/filetree/assets/preloader.gif" /><i class="icon-folder-close"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

    </div>

    <div data-bind="ifnot: loading">
            
        <!-- ko if: expanded() -->

        <a href="#" data-toggle="context" data-target="#context-menu" data-bind="click: toggle"><i class="icon-chevron-down"></i><i class="icon-folder-open"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

        <!-- ko ifnot: expanded() -->

        <a href="#" data-toggle="context" data-target="#context-menu" data-bind="click: toggle"><i class="icon-chevron-right"></i><i class="icon-folder-close"></i><span data-bind="text:name"></span></a>     

        <!-- /ko -->

    </div>  
        
    <div data-bind="if: expanded">

        <ul class="nav nav-list" data-bind="foreach: contents">
                
            <!-- ko if: type() == 'folder' -->

                <li data-bind="template:{name:'template.folder', data:$data}" />
                
            <!-- /ko -->
                        
            <!-- ko if: type() == 'file' -->

                <li data-bind="template:{name:'template.file', data:$data}" />

            <!-- /ko -->
            
        </ul>

    </div>

	<div id="context-menu">

	    <ul class="dropdown-menu" role="menu">

            <li><a tabindex="-1" href="#">Expand</a></li>

            <li class="divider"></li>

            <li><a tabindex="-1" href="#">Cut</a></li>

            <li><a tabindex="-1" href="#">Copy</a></li>

            <li><a tabindex="-1" href="#">Delete</a></li>

            <li><a tabindex="-1" href="#">Paste</a></li>

	    </ul>

	</div>

</script>   

<!-- FileModel Template -->

<script type="text/html" id="template.file">

    <div data-bind="if: loading">

    <a href="#" data-toggle="context" data-target="#context-menu" data-bind="click: load"><img class='icon-space' src="/public/views/editor/components/filetree/assets/preloader.gif" /><i class="icon-file"></i><span data-bind="text:name"></span></a>

    </div>

    <div data-bind="ifnot: loading">

    <a href="#" data-toggle="context" data-target="#context-menu" data-bind="click: load"><i class="icon-space"></i><i class="icon-file"></i><span data-bind="text:name"></span></a>

    </div>

	<div id="Div1">

	    <ul class="dropdown-menu" role="menu">

            <li><a tabindex="-1" href="#">Open</a></li>

            <li class="divider"></li>

            <li><a tabindex="-1" href="#">Cut</a></li>

            <li><a tabindex="-1" href="#">Copy</a></li>

            <li><a tabindex="-1" href="#">Delete</a></li>

            <li><a tabindex="-1" href="#">Paste</a></li>

	    </ul>

	</div>

</script>    
    
<div class="well sidebar-nav">
        
    <ul class="nav nav-list" data-bind="foreach: tree().contents()">
            
        <!-- ko if: type() == 'storage' -->

            <li data-bind="template:{name:'template.storage', data:$data}" />
                
        <!-- /ko -->

        <!-- ko if: type() == 'folder' -->

            <li data-bind="template:{name:'template.folder', data:$data}" />
                
        <!-- /ko -->   
                                 
        <!-- ko if: type() == 'file' -->

            <li data-bind="template:{name:'template.file', data:$data}" />

        <!-- /ko -->
            
    </ul>

</div>