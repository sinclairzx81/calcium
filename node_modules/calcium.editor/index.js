var calcium;
(function (calcium) {
    calcium.web = require('calcium.web');
    calcium.template = require('calcium.template');
    calcium.logging = require('calcium.logging');
    calcium.storage = require('calcium.storage');
})(calcium || (calcium = {}));
var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var calcium;
(function (calcium) {
    (function (editor) {
        var StaticRouter = (function (_super) {
            __extends(StaticRouter, _super);
            function StaticRouter(directory) {
                var _this = this;
                _super.call(this);

                this.storage = new calcium.storage.local.Storage({ basepath: directory });

                this.get("/[path]", function (app) {
                    _this.index(app);
                });
            }
            StaticRouter.prototype.index = function (context) {
                var path = calcium.storage.util.path.join(['/', context.parameter.path]);

                if (calcium.storage.util.path.isfile(path)) {
                    this.storage.readstream(path, function (readstream) {
                        if (!readstream) {
                            context.response.writeHead(404, { 'content-type': 'text/plain' });

                            context.response.end('not found');

                            return;
                        }

                        var mime = calcium.storage.util.mime.fromfilename(path);

                        context.response.writeHead(200, { 'content-type': mime });

                        readstream.pipe(context.response);
                    });

                    return;
                } else {
                    this.storage.readfolder(path, function (objects) {
                        var json = JSON.stringify(objects, null, ' ');

                        context.response.writeHead(200, { 'content-type': 'application/json' });

                        context.response.end(json);
                    });
                }
            };
            return StaticRouter;
        })(calcium.web.Router);
        editor.StaticRouter = StaticRouter;

        var EditorRouter = (function (_super) {
            __extends(EditorRouter, _super);
            function EditorRouter() {
                _super.call(this);

                this.get('/', this.index);
            }
            EditorRouter.prototype.index = function (context) {
                context.response.writeHead(200, { 'content-type': 'text/plain' });

                context.response.end('index');
            };
            return EditorRouter;
        })(calcium.web.Router);
        editor.EditorRouter = EditorRouter;

        var App = (function (_super) {
            __extends(App, _super);
            function App(directory) {
                _super.call(this);

                this.storage = new calcium.storage.local.Storage({ basepath: directory });

                this.routers.push(new calcium.editor.EditorRouter());

                this.routers.push(new calcium.editor.StaticRouter(__dirname + "/"));
            }
            return App;
        })(calcium.web.App);
        editor.App = App;
    })(calcium.editor || (calcium.editor = {}));
    var editor = calcium.editor;
})(calcium || (calcium = {}));
exports = calcium.editor;
module.exports = exports;