@{ this.layout = '/layout.html' } 

@section scripts() {

    <script type="text/javascript" src="/static/script/jquery/jquery-1.10.1.min.js"></script>
    
    <script type="text/javascript" src="/static/script/knockoutjs/knockout-2.2.1.js"></script>
    
    <script type="text/javascript" src="/static/script/calcium/calcium.api.js"></script>
    
    <script type="text/javascript">
        
        var FileModel = function(name, path, mime) 
        {    
            this.type     = ko.observable('file');

            this.name     = ko.observable(name);

            this.path     = ko.observable(path);

            this.mime     = ko.observable(mime);
        }

        var FolderModel = function(name, path) 
        {    
            this.type     = ko.observable('folder');

            this.name     = ko.observable(name);

            this.path     = ko.observable(path);

            this.contents = ko.observableArray([]);            

            this.load = function()
            {   
                var that = this;

                calcium.api.get("/storage" + this.path(), function(contents) {
                    
                    for(var n in contents) 
                    {
                        switch( contents[n].type )
                        {
                            case "folder":
                            
                                var name = contents[n].name;

                                var path = contents[n].fullpath;
                                
                                var model = new FolderModel(name, path);
                                
                                model.load();

                                that.contents.push( model );

                                break;

                            case "file":
                                
                                var name = contents[n].name;

                                var path = contents[n].fullpath;

                                var mime = contents[n].mime;

                                that.contents.push( new FileModel(name, path, mime) );

                                break;
                        }
                    }
                });
            }
        }
        
        function PageModel()
        {
            this.tree =  ko.observable( new FolderModel('root', '/') );

            this.tree().load();
        }

        function initialize() 
        {    
            ko.applyBindings( new PageModel() );
        }


        // jquery junk

        //function load()    { calcium.api.get("/storage/" + $('#path').val(), function(result) { $('#content').html( JSON.stringify(result, null, ' ') ); }); }

        //function jqinit()  { $('#path').keypress( function(e) { if (e.which == 13) { load(); }}); load(); }
        
        $(document).ready(function(){ initialize(); });
        
    </script>
}

@section sidebar() {
    
    <script type="text/html" id="template.folder">

        <a data-bind="text:name" href="#"></a>        
        
        <ul class="nav nav-list" data-bind="foreach: contents">
            
            <!-- ko if: type() == 'folder' -->

                <li data-bind="template:{name:'template.folder', data:$data}" />
                
            <!-- /ko -->
                        
            <!-- ko if: type() == 'file' -->

                <li data-bind="template:{name:'template.file', data:$data}" />

            <!-- /ko -->
            
        </ul>

    </script>   

    <script type="text/html" id="template.file">

        <a data-bind="text:name" href="#"></a>

    </script>    

    <div class="well sidebar-nav">
        
        <ul class="nav nav-list" data-bind="foreach: tree().contents()">
            
            <!-- ko if: type() == 'folder' -->

                <li data-bind="template:{name:'template.folder', data:$data}" />
                
            <!-- /ko -->
                        
            <!-- ko if: type() == 'file' -->

                <li data-bind="template:{name:'template.file', data:$data}" />

            <!-- /ko -->
            
        </ul>

    </div>
}

@section content() {

    <input type="text" id="path" />

    <button class="btn" id="go">></button>

    <pre><code id="content">content here</code></pre>
}   