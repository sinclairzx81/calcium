/// <reference path="decl/references.ts" />

module calcium.editor 
{    
    export class StaticRouter extends calcium.web.Router 
    {
        public storage : calcium.storage.Storage;

        constructor(directory:string)  
        { 
            super();
            
            this.storage = new calcium.storage.local.Storage({ basepath: directory });

            this.get("/[path]", (app) => { this.index(app);  });
        }
        
        public index(context:calcium.web.Context) : void 
        {    
            var path = calcium.storage.util.path.join(['/', context.parameter.path]);
            
            if( calcium.storage.util.path.isfile(path) ) 
            {
                this.storage.readstream(path, (readstream) => 
                {
                    if(!readstream) 
                    {    
                        context.response.writeHead(404, {'content-type' : 'text/plain'});

                        context.response.end('not found');

                        return;
                    }
                    
                    var mime = calcium.storage.util.mime.fromfilename(path);

                    context.response.writeHead(200, {'content-type' : mime});

                    readstream.pipe(context.response);
                });
                
                return;
            } 
            else  
            {
                this.storage.readfolder(path, (objects) => 
                {    
                    var json = JSON.stringify(objects, null, ' ');

                    context.response.writeHead(200, {'content-type' : 'application/json'});

                    context.response.end(json);     
                });
            }
        }
    }

    export class EditorRouter extends calcium.web.Router
    {
        constructor()
        {
            super();

            this.get('/', this.index);
        }

        public index(context:calcium.web.Context) : void 
        {
            context.response.writeHead(200, {'content-type' : 'text/plain'});

            context.response.end('index');
        }
    }
    
    export class App extends calcium.web.App 
    {    
        public storage : calcium.storage.Storage;

        constructor(directory:string) 
        {            
            super();
            
            this.storage = new calcium.storage.local.Storage({ basepath: directory });
            
            this.routers.push( new calcium.editor.EditorRouter  ( ) );

            this.routers.push( new calcium.editor.StaticRouter ( __dirname + "/" ) );
        }
    }
}